<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODUCTION ALL AREA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7f9;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        
        .period {
            font-size: 1.2rem;
            font-weight: 300;
        }
        
        .upload-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        #excel-file {
            display: none;
        }
        
        #upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
            width: 100%;
            max-width: 500px;
        }
        
        #upload-area:hover, #upload-area.dragover {
            border-color: #4e73df;
            background-color: #f0f4ff;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #4e73df;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
        }
        
        .upload-text h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4e73df;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .kpi-title {
            font-size: 1rem;
            color: #555;
            margin-bottom: 15px;
        }
        
        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .gauge-container {
            height: 150px;
            position: relative;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .chart-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .data-preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .data-preview th, .data-preview td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-preview th {
            background-color: #4a6491;
            color: white;
            font-weight: 500;
        }
        
        .data-preview tr:hover {
            background-color: #f9f9f9;
        }
        
        .error-message {
            color: #e74a3b;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8d7da;
            border-radius: 5px;
            display: none;
        }
        
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .kpi-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .kpi-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PRODUCTION ALL AREA</h1>
            <div class="period">Periode: <span id="period-value">Unggah file Excel untuk melihat periode</span></div>
        </header>
        
        <div class="error-message" id="error-message"></div>
        
        <div class="upload-container" id="upload-container">
            <input type="file" id="excel-file" accept=".xlsx, .xls" hidden>
            <div id="upload-area">
                <div class="upload-icon">ðŸ“¤</div>
                <div class="upload-text">
                    <h3>Unggah File Excel</h3>
                    <p>Klik atau seret file Excel ke sini (2KB - 30MB)</p>
                    <p><small>Pastikan file memiliki kolom: Area, Plant Name, ANN FM Target, MTD VOL, % of Target, Avg Vol.Day, RMC Schedule, Actual Supply</small></p>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Memproses data...</p>
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <div class="kpi-container">
                <div class="kpi-card">
                    <div class="kpi-title">Total Area</div>
                    <div class="kpi-value" id="total-area">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Total Plant</div>
                    <div class="kpi-value" id="total-plant">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">% of Target</div>
                    <div class="kpi-value" id="target-percent">0%</div>
                    <div class="gauge-container">
                        <canvas id="targetGauge"></canvas>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">% Actual Supply</div>
                    <div class="kpi-value" id="supply-percent">0%</div>
                    <div class="gauge-container">
                        <canvas id="supplyGauge"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">MTD VOL vs ANN FM Target per Plant</div>
                    <div class="chart-container">
                        <canvas id="volumeTargetChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">% of Target per Plant</div>
                    <div class="chart-container">
                        <canvas id="targetPercentChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Avg Vol. Day per Plant</div>
                    <div class="chart-container">
                        <canvas id="avgVolumeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">RMC Schedule vs MTD VOL per Plant</div>
                    <div class="chart-container">
                        <canvas id="rmcVolumeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">% Actual Supply per Plant</div>
                    <div class="chart-container">
                        <canvas id="supplyPercentChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="data-preview" id="data-preview">
                <h3>Pratinjau Data (10 Baris Pertama)</h3>
                <table>
                    <thead id="preview-head">
                        <tr>
                            <th>Area</th>
                            <th>Plant</th>
                            <th>ANN FM Target</th>
                            <th>MTD VOL</th>
                            <th>% of Target</th>
                            <th>Avg Vol.Day</th>
                            <th>RMC Schedule</th>
                            <th>Actual Supply</th>
                        </tr>
                    </thead>
                    <tbody id="preview-body">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            Production All Area by L=23-51Xe
        </footer>
    </div>

    <script>
        // Inisialisasi variabel global untuk chart
        let charts = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('excel-file');
            const uploadArea = document.getElementById('upload-area');
            
            // Event listener untuk upload file
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileUpload({ target: { files: e.dataTransfer.files } });
                    }
                });
            }
            
            // Inisialisasi chart dengan data kosong
            initializeCharts();
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            
            if (!file) return;
            
            // Validasi ukuran file (2KB - 30MB)
            if (file.size < 2 * 1024 || file.size > 30 * 1024 * 1024) {
                showError('Ukuran file harus antara 2KB dan 30MB');
                return;
            }
            
            // Validasi tipe file
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('Hanya file Excel (.xlsx, .xls) yang diperbolehkan');
                return;
            }
            
            // Tampilkan loading indicator
            showLoading();
            hideError();
            
            // Parse file Excel
            parseExcelFile(file)
                .then(data => {
                    // Simulasikan pemrosesan data
                    setTimeout(() => {
                        processData(data);
                        hideUploadArea();
                        hideLoading();
                        document.getElementById('dashboard-content').style.display = 'block';
                    }, 1500);
                })
                .catch(error => {
                    console.error('Error parsing Excel:', error);
                    showError('Error parsing file Excel: ' + error.message);
                    hideLoading();
                });
        }
        
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                        
                        // Ambil sheet pertama
                        const firstSheet = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheet];
                        
                        // Konversi ke JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                        
                        // Ambil periode dari sel E1 (konversi dari format Excel)
                        let period = "Data tidak ditemukan";
                        if (worksheet['E1']) {
                            const excelDate = worksheet['E1'].v;
                            if (typeof excelDate === 'number') {
                                // Konversi dari serial number Excel ke tanggal JavaScript
                                period = convertExcelDateToJSDate(excelDate).toLocaleDateString('id-ID', {
                                    year: 'numeric',
                                    month: 'long'
                                });
                            } else {
                                period = excelDate;
                            }
                        }
                        
                        document.getElementById('period-value').textContent = period;
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function(error) {
                    reject(error);
                };
                
                reader.readAsBinaryString(file);
            });
        }
        
        // Fungsi untuk mengonversi tanggal Excel ke JavaScript Date
        function convertExcelDateToJSDate(excelDate) {
            // Excel dates are based on January 1, 1900
            const excelEpoch = new Date(1900, 0, 1);
            const jsDate = new Date(excelEpoch.getTime() + (excelDate - 1) * 24 * 60 * 60 * 1000);
            
            // Adjust for Excel's leap year bug (it considers 1900 as a leap year)
            if (excelDate > 59) {
                jsDate.setTime(jsDate.getTime() - 24 * 60 * 60 * 1000);
            }
            
            return jsDate;
        }
        
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function hideUploadArea() {
            document.getElementById('upload-container').style.display = 'none';
        }
        
        function processData(data) {
            if (!data || data.length === 0) {
                showError('Tidak ada data yang ditemukan dalam file');
                return;
            }
            
            // Normalisasi data
            const normalizedData = normalizeData(data);
            
            // Tampilkan preview data
            showDataPreview(normalizedData);
            
            // Update dashboard dengan data yang telah diproses
            updateDashboard(normalizedData);
        }
        
        function normalizeData(data) {
            // Implementasi normalisasi data
            // Menyamakan penulisan kolom tanpa memperdulikan huruf besar/kecil dan spasi
            const normalized = [];
            
            data.forEach(row => {
                const normalizedRow = {};
                for (const key in row) {
                    if (row.hasOwnProperty(key)) {
                        // Normalisasi nama kolom
                        const normalizedKey = key.trim().toLowerCase().replace(/[/\s+]/g, '');
                        normalizedRow[normalizedKey] = row[key];
                    }
                }
                normalized.push(normalizedRow);
            });
            
            return normalized;
        }
        
        function showDataPreview(data) {
            const previewBody = document.getElementById('preview-body');
            previewBody.innerHTML = '';
            
            // Tampilkan maksimal 10 baris
            const previewData = data.slice(0, 10);
            
            if (previewData.length === 0) {
                previewBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Tidak ada data untuk ditampilkan</td></tr>';
                return;
            }
            
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                
                // Ambil nilai dari kolom yang dinormalisasi dengan berbagai variasi nama
                const area = row['area'] || row['arearea'] || 'N/A';
                const plant = row['plant'] || row['plantname'] || row['plant'] || 'N/A';
                const target = row['annfmtarget'] || row['annfmtarget'] || row['annfm_target'] || 0;
                const mtdVol = row['mtdvol'] || row['mtdvolume'] || row['mtdvol'] || 0;
                const percent = row['%oftarget'] || row['%oftarget'] || row['targetpercent'] || 0;
                const avgVol = row['avgvol.day'] || row['avgvolday'] || row['avgvolday'] || 0;
                const rmc = row['rmcschedule'] || row['rmcschedule'] || row['rmc_schedule'] || 0;
                const actual = row['actualsupply'] || row['actualsupply'] || row['actual_supply'] || 0;
                
                tr.innerHTML = `
                    <td>${area}</td>
                    <td>${plant}</td>
                    <td>${target}</td>
                    <td>${mtdVol}</td>
                    <td>${percent}%</td>
                    <td>${avgVol}</td>
                    <td>${rmc}</td>
                    <td>${actual}%</td>
                `;
                
                previewBody.appendChild(tr);
            });
        }
        
        function initializeCharts() {
            // Inisialisasi semua chart dengan data kosong
            const chartIds = [
                'targetGauge', 'supplyGauge', 
                'volumeTargetChart', 'targetPercentChart', 
                'avgVolumeChart', 'rmcVolumeChart', 'supplyPercentChart'
            ];
            
            chartIds.forEach(id => {
                const ctx = document.getElementById(id).getContext('2d');
                
                // Buat chart berdasarkan jenisnya
                switch(id) {
                    case 'targetGauge':
                    case 'supplyGauge':
                        charts[id] = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                datasets: [{
                                    data: [0, 100],
                                    backgroundColor: ['#4e73df', '#e0e0e0'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                cutout: '70%',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { enabled: false }
                                }
                            }
                        });
                        break;
                    default:
                        charts[id] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Data',
                                    data: [],
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                }
            });
        }
        
        function updateDashboard(data) {
            if (!data || data.length === 0) {
                showError('Tidak ada data yang valid untuk ditampilkan');
                return;
            }
            
            // Hitung nilai KPI
            const areas = new Set();
            const plants = new Set();
            let totalTarget = 0;
            let totalMtdVol = 0;
            let totalRmcSchedule = 0;
            let totalActualSupply = 0;
            
            data.forEach(row => {
                const area = row['area'] || row['arearea'] || '';
                const plant = row['plant'] || row['plantname'] || row['plant'] || '';
                const target = parseFloat(row['annfmtarget'] || row['annfmtarget'] || 0);
                const mtdVol = parseFloat(row['mtdvol'] || row['mtdvolume'] || 0);
                const rmcSchedule = parseFloat(row['rmcschedule'] || row['rmcschedule'] || 0);
                const actualSupply = parseFloat(row['actualsupply'] || row['actualsupply'] || 0);
                
                if (area) areas.add(area);
                if (plant) plants.add(plant);
                
                totalTarget += isNaN(target) ? 0 : target;
                totalMtdVol += isNaN(mtdVol) ? 0 : mtdVol;
                totalRmcSchedule += isNaN(rmcSchedule) ? 0 : rmcSchedule;
                totalActualSupply += isNaN(actualSupply) ? 0 : actualSupply;
            });
            
            // Update KPI
            document.getElementById('total-area').textContent = areas.size;
            document.getElementById('total-plant').textContent = plants.size;
            
            const targetPercent = totalTarget > 0 ? (totalMtdVol / totalTarget * 100).toFixed(1) : 0;
            const supplyPercent = totalRmcSchedule > 0 ? (totalMtdVol / totalRmcSchedule * 100).toFixed(1) : 0;
            
            document.getElementById('target-percent').textContent = `${targetPercent}%`;
            document.getElementById('supply-percent').textContent = `${supplyPercent}%`;
            
            // Update gauge charts
            updateGaugeChart('targetGauge', targetPercent);
            updateGaugeChart('supplyGauge', supplyPercent);
            
            // Siapkan data untuk chart
            const plantData = {};
            
            data.forEach(row => {
                const plant = row['plant'] || row['plantname'] || row['plant'] || 'Unknown';
                if (!plantData[plant]) {
                    plantData[plant] = {
                        target: 0,
                        mtdVol: 0,
                        targetPercent: 0,
                        avgVolDay: 0,
                        rmcSchedule: 0,
                        actualSupply: 0
                    };
                }
                
                const target = parseFloat(row['annfmtarget'] || row['annfmtarget'] || 0);
                const mtdVol = parseFloat(row['mtdvol'] || row['mtdvolume'] || 0);
                const targetPercent = parseFloat(row['%oftarget'] || row['%oftarget'] || 0);
                const avgVolDay = parseFloat(row['avgvol.day'] || row['avgvolday'] || 0);
                const rmcSchedule = parseFloat(row['rmcschedule'] || row['rmcschedule'] || 0);
                const actualSupply = parseFloat(row['actualsupply'] || row['actualsupply'] || 0);
                
                plantData[plant].target += isNaN(target) ? 0 : target;
                plantData[plant].mtdVol += isNaN(mtdVol) ? 0 : mtdVol;
                plantData[plant].targetPercent += isNaN(targetPercent) ? 0 : targetPercent;
                plantData[plant].avgVolDay += isNaN(avgVolDay) ? 0 : avgVolDay;
                plantData[plant].rmcSchedule += isNaN(rmcSchedule) ? 0 : rmcSchedule;
                plantData[plant].actualSupply += isNaN(actualSupply) ? 0 : actualSupply;
            });
            
            const plantNames = Object.keys(plantData);
            
            if (plantNames.length === 0) {
                showError('Tidak ada data plant yang valid untuk ditampilkan');
                return;
            }
            
            // Update chart data
            updateChartData('volumeTargetChart', plantNames, 
                [plantNames.map(p => plantData[p].mtdVol), plantNames.map(p => plantData[p].target)],
                ['MTD VOL', 'ANN FM Target'],
                ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 1)'],
                ['bar', 'line']
            );
            
            updateChartData('targetPercentChart', plantNames, 
                [plantNames.map(p => plantData[p].targetPercent)],
                ['% of Target'],
                ['rgba(75, 192, 192, 0.7)'],
                ['bar']
            );
            
            updateChartData('avgVolumeChart', plantNames, 
                [plantNames.map(p => plantData[p].avgVolDay)],
                ['Avg Vol. Day'],
                ['rgba(153, 102, 255, 0.7)'],
                ['line']
            );
            
            updateChartData('rmcVolumeChart', plantNames, 
                [plantNames.map(p => plantData[p].mtdVol), plantNames.map(p => plantData[p].rmcSchedule)],
                ['MTD VOL', 'RMC Schedule'],
                ['rgba(54, 162, 235, 0.7)', 'rgba(255, 159, 64, 1)'],
                ['bar', 'line']
            );
            
            updateChartData('supplyPercentChart', plantNames, 
                [plantNames.map(p => plantData[p].actualSupply)],
                ['% Actual Supply'],
                ['rgba(255, 205, 86, 0.7)'],
                ['bar']
            );
        }
        
        function updateGaugeChart(chartId, value) {
            if (charts[chartId]) {
                charts[chartId].data.datasets[0].data = [value, 100 - value];
                charts[chartId].update();
            }
        }
        
        function updateChartData(chartId, labels, datasetsData, datasetsLabel, colors, types) {
            if (charts[chartId]) {
                charts[chartId].data.labels = labels;
                
                // Hapus dataset yang ada
                charts[chartId].data.datasets = [];
                
                // Tambahkan dataset baru
                for (let i = 0; i < datasetsData.length; i++) {
                    const dataset = {
                        label: datasetsLabel[i],
                        data: datasetsData[i],
                        backgroundColor: colors[i],
                        borderColor: colors[i].replace('0.7', '1'),
                        borderWidth: 2
                    };
                    
                    if (types[i] === 'line') {
                        dataset.type = 'line';
                        dataset.fill = false;
                        dataset.pointStyle = 'circle';
                        dataset.pointRadius: 5,
                        dataset.pointBorderColor = colors[i].replace('0.7', '1'),
                        dataset.pointBackgroundColor = 'white';
                    }
                    
                    charts[chartId].data.datasets.push(dataset);
                }
                
                charts[chartId].update();
            }
        }
    </script>
</body>
</html>
