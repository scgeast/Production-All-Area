<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODUCTION ALL AREA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7f9;
            color: #333;
            padding: 20px;
            display: flex;
            transition: margin-left 0.3s;
        }
        
        body.sidebar-open {
            margin-left: 280px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            width: 100%;
            gap: 20px;
        }
        
        /* Sidebar Filter */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: white;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 1000;
            transition: left 0.3s;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1001;
            background: #4a6491;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .filter-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-content {
            display: block;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }
        
        .checkbox-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            margin-right: 8px;
            width: auto;
        }
        
        /* Main Content */
        .main-content {
            flex-grow: 1;
            transition: width 0.3s;
        }
        
        header {
            position: relative;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .last-update {
            text-align: right;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .export-btn {
            background: #1e7b1e;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .export-btn.pdf {
            background: #c62828;
        }
        
        .export-btn.pdf:hover {
            background: #d32f2f;
        }
        
        .export-btn:hover {
            background: #2a9a2a;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        
        .period {
            font-size: 1.2rem;
            font-weight: 300;
        }
        
        .upload-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        #excel-file {
            display: none;
        }
        
        #upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
            width: 100%;
            max-width: 500px;
        }
        
        #upload-area:hover, #upload-area.dragover {
            border-color: #4e73df;
            background-color: #f0f4ff;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #4e73df;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
        }
        
        .upload-text h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4e73df;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .kpi-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .kpi-title {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .kpi-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .charts-container.vertical {
            grid-template-columns: 1fr;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .chart-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .data-preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .data-preview th, .data-preview td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-preview th {
            background-color: #4a6491;
            color: white;
            font-weight: 500;
        }
        
        .data-preview tr:hover {
            background-color: #f9f9f9;
        }
        
        .percentage-cell {
            text-align: right;
            font-weight: 500;
        }
        
        .error-message {
            color: #e74a3b;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8d7da;
            border-radius: 5px;
            display: none;
        }
        
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                flex-direction: column;
            }
        }
        
        @media (max-width: 992px) {
            body.sidebar-open {
                margin-left: 0;
            }
            
            .header-top {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .last-update {
                text-align: center;
            }
            
            .export-buttons {
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .kpi-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sidebar {
                width: 250px;
                left: -250px;
            }
            
            body.sidebar-open {
                margin-left: 250px;
            }
            
            .kpi-title {
                font-size: 0.8rem;
            }
            
            .kpi-value {
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-container {
                grid-template-columns: 1fr;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-angle-right" id="sidebar-icon"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="filter-section">
            <div class="filter-header" onclick="toggleFilter('period-filter')">
                <div class="filter-title">Periode (Bulan)</div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="filter-content" id="period-filter">
                <div class="filter-group">
                    <label for="period-select">Pilih Bulan</label>
                    <select id="period-select" onchange="applyPeriodFilter()">
                        <option value="all">Semua Bulan</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-header" onclick="toggleFilter('area-filter')">
                <div class="filter-title">Area</div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="filter-content" id="area-filter">
                <div class="checkbox-item">
                    <input type="checkbox" id="select-all-areas" onchange="toggleAllAreas(this.checked)">
                    <label for="select-all-areas">Select All</label>
                </div>
                <div class="checkbox-group" id="area-checkboxes">
                    <!-- Area options will be populated here -->
                </div>
                <button class="export-btn" onclick="applyAreaFilter()">
                    <i class="fas fa-check"></i> Terapkan Filter
                </button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <header>
            <div class="header-top">
                <div class="last-update">
                    Last Update: <span id="last-update-time"></span>
                </div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="export-btn pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
            
            <h1>PRODUCTION ALL AREA</h1>
            <div class="period">Periode: <span id="period-value">Unggah file Excel untuk melihat periode</span></div>
        </header>
        
        <div class="error-message" id="error-message"></div>
        
        <div class="upload-container" id="upload-container">
            <input type="file" id="excel-file" accept=".xlsx, .xls">
            <div id="upload-area">
                <div class="upload-icon">ðŸ“¤</div>
                <div class="upload-text">
                    <h3>Unggah File Excel</h3>
                    <p>Klik atau seret file Excel ke sini (2KB - 30MB)</p>
                    <p><small>Pastikan file memiliki kolom: Area, Plant Name, ANN FM Target, MTD VOL, % of Target, Avg Vol.Day, RMC Schedule, Actual Supply</small></p>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Memproses data...</p>
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <div class="kpi-container">
                <div class="kpi-card">
                    <div class="kpi-title">Total Area</div>
                    <div class="kpi-value" id="total-area">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Total Plant</div>
                    <div class="kpi-value" id="total-plant">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">% of Target</div>
                    <div class="kpi-value" id="target-percent">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">% Actual Supply</div>
                    <div class="kpi-value" id="supply-percent">0%</div>
                </div>
            </div>
            
            <div class="charts-container" id="charts-container">
                <div class="chart-card">
                    <div class="chart-title">MTD VOL vs ANN FM Target per Plant</div>
                    <div class="chart-container">
                        <canvas id="volumeTargetChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">% of Target per Plant</div>
                    <div class="chart-container">
                        <canvas id="targetPercentChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Avg Vol. Day per Plant</div>
                    <div class="chart-container">
                        <canvas id="avgVolumeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">RMC Schedule vs MTD VOL per Plant</div>
                    <div class="chart-container">
                        <canvas id="rmcVolumeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">% Actual Supply per Plant</div>
                    <div class="chart-container">
                        <canvas id="supplyPercentChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="data-preview" id="data-preview">
                <h3>Pratinjau Data</h3>
                <table>
                    <thead id="preview-head">
                        <tr>
                            <th>Periode</th>
                            <th>Area</th>
                            <th>Plant</th>
                            <th>ANN FM Target</th>
                            <th>MTD VOL</th>
                            <th>% of Target</th>
                            <th>RMC Schedule</th>
                            <th>% Actual Supply</th>
                        </tr>
                    </thead>
                    <tbody id="preview-body">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            Production All Area by L=23-51Xe
        </footer>
    </div>

    <script>
        // Inisialisasi variabel global untuk chart
        let charts = {};
        let rawData = [];
        let filteredData = [];
        let allAreas = [];
        let allPeriods = [];
        let currentPeriod = "Semua Periode";
        let isAllAreasSelected = false;
        let activePeriodFilter = "all";
        
        // Update waktu terakhir
        function updateLastUpdateTime() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const formattedTime = now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update-time').textContent = `${formattedDate} ${formattedTime}`;
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarIcon = document.getElementById('sidebar-icon');
            sidebar.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
            
            // Ubah ikon berdasarkan status sidebar
            if (sidebar.classList.contains('open')) {
                sidebarIcon.className = 'fas fa-angle-left';
            } else {
                sidebarIcon.className = 'fas fa-angle-right';
            }
        }
        
        // Toggle filter content
        function toggleFilter(filterId) {
            const filterContent = document.getElementById(filterId);
            filterContent.style.display = filterContent.style.display === 'none' ? 'block' : 'none';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('excel-file');
            const uploadArea = document.getElementById('upload-area');
            
            // Update waktu terakhir
            updateLastUpdateTime();
            
            // Event listener untuk upload file
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileUpload({ target: fileInput });
                    }
                });
            }
            
            // Inisialisasi chart dengan data kosong
            initializeCharts();
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            
            if (!file) return;
            
            // Validasi ukuran file (2KB - 30MB)
            if (file.size < 2 * 1024 || file.size > 30 * 1024 * 1024) {
                showError('Ukuran file harus antara 2KB dan 30MB');
                return;
            }
            
            // Validasi tipe file
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('Hanya file Excel (.xlsx, .xls) yang diperbolehkan');
                return;
            }
            
            // Tampilkan loading indicator
            showLoading();
            hideError();
            
            // Parse file Excel
            parseExcelFile(file)
                .then(data => {
                    // Simulasikan pemrosesan data
                    setTimeout(() => {
                        processData(data);
                        hideUploadArea();
                        hideLoading();
                        document.getElementById('dashboard-content').style.display = 'block';
                        updateLastUpdateTime();
                    }, 1500);
                })
                .catch(error => {
                    console.error('Error parsing Excel:', error);
                    showError('Error parsing file Excel: ' + error.message);
                    hideLoading();
                });
        }
        
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                        
                        // Ambil sheet pertama
                        const firstSheet = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheet];
                        
                        // Konversi ke JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                        
                        // Ambil periode dari header
                        let period = "Data tidak ditemukan";
                        // Coba ambil dari berbagai lokasi yang mungkin
                        if (worksheet['A1'] && worksheet['A1'].v) period = worksheet['A1'].v;
                        if (worksheet['B1'] && worksheet['B1'].v) period = worksheet['B1'].v;
                        
                        currentPeriod = period;
                        document.getElementById('period-value').textContent = period;
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function(error) {
                    reject(error);
                };
                
                reader.readAsBinaryString(file);
            });
        }
        
        // Fungsi untuk mengonversi format angka Indonesia ke format JavaScript
        function parseIndonesianNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // Hapus semua karakter non-numerik kecuali koma dan titik
                let cleanedValue = value.replace(/[^\d,.-]/g, '');
                
                // Jika menggunakan koma sebagai desimal, ganti dengan titik
                if (cleanedValue.includes(',') && !cleanedValue.includes('.')) {
                    cleanedValue = cleanedValue.replace(',', '.');
                }
                
                // Hapus semua pemisah ribuan (titik) jika ada
                cleanedValue = cleanedValue.replace(/\./g, '');
                
                const result = parseFloat(cleanedValue);
                return isNaN(result) ? 0 : result;
            }
            return 0;
        }
        
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function hideUploadArea() {
            document.getElementById('upload-container').style.display = 'none';
        }
        
        function processData(data) {
            if (!data || data.length === 0) {
                showError('Tidak ada data yang ditemukan dalam file');
                return;
            }
            
            // Simpan data mentah untuk debugging
            rawData = data;
            filteredData = data;
            
            // Normalisasi data
            const normalizedData = normalizeData(data);
            
            // Ekstrak daftar area unik untuk filter
            extractAreas(normalizedData);
            
            // Ekstrak daftar periode unik untuk filter
            extractPeriods(normalizedData);
            
            // Tampilkan preview data
            showDataPreview(normalizedData);
            
            // Update dashboard dengan data yang telah diproses
            updateDashboard(normalizedData);
        }
        
        function normalizeData(data) {
            const normalized = [];
            
            data.forEach(row => {
                const normalizedRow = {};
                for (const key in row) {
                    if (row.hasOwnProperty(key)) {
                        // Normalisasi nama kolom
                        const normalizedKey = key.trim().toLowerCase()
                            .replace(/\s+/g, '')     // Hapus semua spasi
                            .replace(/%/g, 'percent') // Ganti % dengan percent
                            .replace(/\//g, '')       // Hapus slash
                            .replace(/\./g, '')       // Hapus titik
                            .replace('-', '');        // Hapus dash
                        
                        normalizedRow[normalizedKey] = row[key];
                    }
                }
                normalized.push(normalizedRow);
            });
            
            return normalized;
        }
        
        function extractAreas(data) {
            const areaSet = new Set();
            
            data.forEach(row => {
                const area = getValue(row, ['area']) || '';
                if (area) areaSet.add(area);
            });
            
            allAreas = Array.from(areaSet).sort();
            populateAreaFilter(allAreas);
        }
        
        function extractPeriods(data) {
            const periodSet = new Set();
            
            data.forEach(row => {
                const period = getValue(row, ['periode', 'period', 'bulan', 'month']) || '';
                if (period) periodSet.add(period);
            });
            
            allPeriods = Array.from(periodSet).sort();
            populatePeriodFilter(allPeriods);
        }
        
        function populateAreaFilter(areas) {
            const container = document.getElementById('area-checkboxes');
            container.innerHTML = '';
            
            areas.forEach(area => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="area-${area}" name="area" value="${area}" checked>
                    <label for="area-${area}">${area}</label>
                `;
                container.appendChild(div);
            });
            
            // Set select all sebagai checked
            document.getElementById('select-all-areas').checked = true;
            isAllAreasSelected = true;
        }
        
        function populatePeriodFilter(periods) {
            const select = document.getElementById('period-select');
            // Hapus opsi selain "Semua Bulan"
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Tambahkan periode ke dropdown
            periods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                select.appendChild(option);
            });
        }
        
        function toggleAllAreas(checked) {
            const checkboxes = document.querySelectorAll('input[name="area"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
            isAllAreasSelected = checked;
        }
        
        function applyAreaFilter() {
            const selectedAreas = [];
            const checkboxes = document.querySelectorAll('input[name="area"]:checked');
            
            checkboxes.forEach(checkbox => {
                selectedAreas.push(checkbox.value);
            });
            
            // Jika semua area dipilih atau tidak ada area yang dipilih (select all)
            if (selectedAreas.length === allAreas.length || selectedAreas.length === 0) {
                isAllAreasSelected = true;
            } else {
                isAllAreasSelected = false;
            }
            
            // Terapkan filter
            applyFilters();
        }
        
        function applyPeriodFilter() {
            const periodSelect = document.getElementById('period-select');
            activePeriodFilter = periodSelect.value;
            
            // Update teks periode yang aktif
            if (activePeriodFilter === 'all') {
                document.getElementById('period-value').textContent = "Semua Periode";
            } else {
                document.getElementById('period-value').textContent = activePeriodFilter;
            }
            
            // Terapkan filter
            applyFilters();
        }
        
        function applyFilters() {
            // Pertama, filter berdasarkan periode
            if (activePeriodFilter === 'all') {
                filteredData = rawData;
            } else {
                filteredData = rawData.filter(row => {
                    const normalizedRow = normalizeData([row])[0];
                    const period = getValue(normalizedRow, ['periode', 'period', 'bulan', 'month']) || '';
                    return period === activePeriodFilter;
                });
            }
            
            // Kemudian, filter berdasarkan area jika tidak memilih "Select All"
            if (!isAllAreasSelected) {
                const selectedAreas = [];
                const checkboxes = document.querySelectorAll('input[name="area"]:checked');
                
                checkboxes.forEach(checkbox => {
                    selectedAreas.push(checkbox.value);
                });
                
                if (selectedAreas.length > 0) {
                    filteredData = filteredData.filter(row => {
                        const normalizedRow = normalizeData([row])[0];
                        const area = getValue(normalizedRow, ['area']) || '';
                        return selectedAreas.includes(area);
                    });
                }
            }
            
            // Ubah layout chart jika select all dipilih
            const chartsContainer = document.getElementById('charts-container');
            if (isAllAreasSelected) {
                chartsContainer.classList.add('vertical');
            } else {
                chartsContainer.classList.remove('vertical');
            }
            
            // Normalisasi data yang sudah difilter
            const normalizedData = normalizeData(filteredData);
            
            // Update tampilan
            showDataPreview(normalizedData);
            updateDashboard(normalizedData);
        }
        
        function showDataPreview(data) {
            const previewBody = document.getElementById('preview-body');
            previewBody.innerHTML = '';
            
            if (data.length === 0) {
                previewBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Tidak ada data untuk ditampilkan</td></tr>';
                return;
            }
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                // Ambil nilai dari kolom
                const periode = getValue(row, ['periode', 'period', 'bulan', 'month']) || currentPeriod;
                const area = getValue(row, ['area']) || 'N/A';
                const plant = getValue(row, ['plantname', 'plant']) || 'N/A';
                const target = parseIndonesianNumber(getValue(row, ['annfmtarget', 'annfm', 'target']));
                const mtdVol = parseIndonesianNumber(getValue(row, ['mtdvol', 'mtdvolume', 'volume']));
                const rmc = parseIndonesianNumber(getValue(row, ['rmcschedule', 'rmc', 'schedule']));
                
                // Hitung % of Target (MTD VOL / ANN FM Target)
                const targetPercent = target > 0 ? (mtdVol / target) * 100 : 0;
                
                // Hitung % Actual Supply (MTD VOL / RMC Schedule)
                const actualSupply = rmc > 0 ? (mtdVol / rmc) * 100 : 0;
                
                tr.innerHTML = `
                    <td>${periode}</td>
                    <td>${area}</td>
                    <td>${plant}</td>
                    <td>${target.toLocaleString('id-ID')}</td>
                    <td>${mtdVol.toLocaleString('id-ID')}</td>
                    <td class="percentage-cell">${targetPercent.toFixed(2)}%</td>
                    <td>${rmc.toLocaleString('id-ID')}</td>
                    <td class="percentage-cell">${actualSupply.toFixed(2)}%</td>
                `;
                
                previewBody.appendChild(tr);
            });
        }
        
        // Helper function untuk mendapatkan nilai dari berbagai kemungkinan key
        function getValue(row, possibleKeys) {
            for (const key of possibleKeys) {
                if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                    return row[key];
                }
            }
            return '';
        }
        
        function initializeCharts() {
            // Inisialisasi semua chart dengan data kosong
            const chartIds = [
                'volumeTargetChart', 'targetPercentChart', 
                'avgVolumeChart', 'rmcVolumeChart', 'supplyPercentChart'
            ];
            
            chartIds.forEach(id => {
                const ctx = document.getElementById(id).getContext('2d');
                
                charts[id] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Data',
                            data: [],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            datalabels: {
                                display: true,
                                color: 'black',
                                align: 'end',
                                anchor: 'end',
                                formatter: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                });
            });
        }
        
        function updateDashboard(data) {
            if (!data || data.length === 0) {
                showError('Tidak ada data yang valid untuk ditampilkan');
                return;
            }
            
            // Hitung nilai KPI
            const areas = new Set();
            const plants = new Set();
            let totalTarget = 0;
            let totalMtdVol = 0;
            let totalRmcSchedule = 0;
            let totalTargetPercent = 0;
            let totalActualSupply = 0;
            let count = 0;
            
            data.forEach(row => {
                const area = getValue(row, ['area']) || '';
                const plant = getValue(row, ['plantname', 'plant']) || '';
                const target = parseIndonesianNumber(getValue(row, ['annfmtarget', 'annfm', 'target']));
                const mtdVol = parseIndonesianNumber(getValue(row, ['mtdvol', 'mtdvolume', 'volume']));
                const rmcSchedule = parseIndonesianNumber(getValue(row, ['rmcschedule', 'rmc', 'schedule']));
                
                // Hitung % of Target (MTD VOL / ANN FM Target)
                const targetPercent = target > 0 ? (mtdVol / target) * 100 : 0;
                
                // Hitung % Actual Supply (MTD VOL / RMC Schedule)
                const actualSupply = rmcSchedule > 0 ? (mtdVol / rmcSchedule) * 100 : 0;
                
                if (area) areas.add(area);
                if (plant) plants.add(plant);
                
                totalTarget += isNaN(target) ? 0 : target;
                totalMtdVol += isNaN(mtdVol) ? 0 : mtdVol;
                totalRmcSchedule += isNaN(rmcSchedule) ? 0 : rmcSchedule;
                totalTargetPercent += isNaN(targetPercent) ? 0 : targetPercent;
                totalActualSupply += isNaN(actualSupply) ? 0 : actualSupply;
                count++;
            });
            
            // Update KPI
            document.getElementById('total-area').textContent = areas.size;
            document.getElementById('total-plant').textContent = plants.size;
            
            const avgTargetPercent = count > 0 ? (totalTargetPercent / count) : 0;
            const avgActualSupply = count > 0 ? (totalActualSupply / count) : 0;
            
            document.getElementById('target-percent').textContent = `${avgTargetPercent.toFixed(2)}%`;
            document.getElementById('supply-percent').textContent = `${avgActualSupply.toFixed(2)}%`;
            
            // Siapkan data untuk chart berdasarkan plant
            const plantData = {};
            
            data.forEach(row => {
                const plant = getValue(row, ['plantname', 'plant']) || 'Unknown';
                if (!plantData[plant]) {
                    plantData[plant] = {
                        target: 0,
                        mtdVol: 0,
                        targetPercent: 0,
                        avgVolDay: 0,
                        rmcSchedule: 0,
                        actualSupply: 0,
                        count: 0
                    };
                }
                
                const target = parseIndonesianNumber(getValue(row, ['annfmtarget', 'annfm', 'target']));
                const mtdVol = parseIndonesianNumber(getValue(row, ['mtdvol', 'mtdvolume', 'volume']));
                const rmcSchedule = parseIndonesianNumber(getValue(row, ['rmcschedule', 'rmc', 'schedule']));
                const avgVolDay = parseIndonesianNumber(getValue(row, ['avgvolday', 'avgvolume', 'average']));
                
                // Hitung % of Target (MTD VOL / ANN FM Target)
                const targetPercent = target > 0 ? (mtdVol / target) * 100 : 0;
                
                // Hitung % Actual Supply (MTD VOL / RMC Schedule)
                const actualSupply = rmcSchedule > 0 ? (mtdVol / rmcSchedule) * 100 : 0;
                
                plantData[plant].target += isNaN(target) ? 0 : target;
                plantData[plant].mtdVol += isNaN(mtdVol) ? 0 : mtdVol;
                plantData[plant].targetPercent += isNaN(targetPercent) ? 0 : targetPercent;
                plantData[plant].avgVolDay += isNaN(avgVolDay) ? 0 : avgVolDay;
                plantData[plant].rmcSchedule += isNaN(rmcSchedule) ? 0 : rmcSchedule;
                plantData[plant].actualSupply += isNaN(actualSupply) ? 0 : actualSupply;
                plantData[plant].count += 1;
            });
            
            const plantNames = Object.keys(plantData);
            
            if (plantNames.length === 0) {
                showError('Tidak ada data plant yang valid untuk ditampilkan');
                return;
            }
            
            // Update chart data
            updateChartData('volumeTargetChart', plantNames, 
                [plantNames.map(p => plantData[p].mtdVol), plantNames.map(p => plantData[p].target)],
                ['MTD VOL', 'ANN FM Target'],
                ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 1)'],
                ['bar', 'bar'],
                [true, true]
            );
            
            updateChartData('targetPercentChart', plantNames, 
                [plantNames.map(p => plantData[p].targetPercent / plantData[p].count)],
                ['% of Target'],
                ['rgba(75, 192, 192, 0.7)'],
                ['bar'],
                [true]
            );
            
            updateChartData('avgVolumeChart', plantNames, 
                [plantNames.map(p => plantData[p].avgVolDay / plantData[p].count)],
                ['Avg Vol. Day'],
                ['rgba(153, 102, 255, 0.7)'],
                ['line'],
                [true]
            );
            
            updateChartData('rmcVolumeChart', plantNames, 
                [plantNames.map(p => plantData[p].mtdVol), plantNames.map(p => plantData[p].rmcSchedule)],
                ['MTD VOL', 'RMC Schedule'],
                ['rgba(54, 162, 235, 0.7)', 'rgba(255, 159, 64, 1)'],
                ['bar', 'line'],
                [true, true]
            );
            
            updateChartData('supplyPercentChart', plantNames, 
                [plantNames.map(p => plantData[p].actualSupply / plantData[p].count)],
                ['% Actual Supply'],
                ['rgba(255, 205, 86, 0.7)'],
                ['bar'],
                [true]
            );
        }
        
        function updateChartData(chartId, labels, datasetsData, datasetsLabel, colors, types, showDataLabels) {
            if (charts[chartId]) {
                charts[chartId].data.labels = labels;
                
                // Hapus dataset yang ada
                charts[chartId].data.datasets = [];
                
                // Tambahkan dataset baru
                for (let i = 0; i < datasetsData.length; i++) {
                    const dataset = {
                        label: datasetsLabel[i],
                        data: datasetsData[i],
                        backgroundColor: colors[i],
                        borderColor: colors[i].replace('0.7', '1'),
                        borderWidth: 2
                    };
                    
                    if (types[i] === 'line') {
                        dataset.type = 'line';
                        dataset.fill = false;
                        dataset.pointStyle = 'circle';
                        dataset.pointRadius = 5;
                        dataset.pointBorderColor = colors[i].replace('0.7', '1');
                        dataset.pointBackgroundColor = 'white';
                        dataset.tension = 0.1;
                    }
                    
                    charts[chartId].data.datasets.push(dataset);
                }
                
                // Konfigurasi data labels
                charts[chartId].options.plugins.datalabels = {
                    display: function(context) {
                        return showDataLabels[context.datasetIndex] || false;
                    },
                    color: function(context) {
                        // Beri warna merah untuk target, biru untuk lainnya
                        return context.datasetIndex === 1 ? 'red' : 'blue';
                    },
                    align: 'end',
                    anchor: 'end',
                    formatter: function(value) {
                        return value.toFixed(1);
                    }
                };
                
                charts[chartId].update();
            }
        }
        
        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diexport');
                return;
            }
            
            // Buat worksheet dari data
            const ws = XLSX.utils.json_to_sheet(filteredData);
            
            // Buat workbook dan tambahkan worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Production Data");
            
            // Export ke file Excel
            XLSX.writeFile(wb, "production_data.xlsx");
        }
        
        function exportToPDF() {
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diexport');
                return;
            }
            
            // Buat instance jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Tambahkan judul
            doc.setFontSize(18);
            doc.text('PRODUCTION REPORT', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Periode: ${document.getElementById('period-value').textContent}`, 105, 22, { align: 'center' });
            doc.text(`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`, 105, 28, { align: 'center' });
            
            // Capture charts as images and add to PDF
            let yPosition = 40;
            const chartIds = [
                'volumeTargetChart', 'targetPercentChart', 
                'avgVolumeChart', 'rmcVolumeChart', 'supplyPercentChart'
            ];
            
            const chartPromises = chartIds.map((chartId, index) => {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        html2canvas(document.getElementById(chartId)).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            
                            // Add chart to PDF
                            if (index > 0 && index % 2 === 0) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            
                            const imgWidth = 90;
                            const imgHeight = canvas.height * imgWidth / canvas.width;
                            
                            if (index % 2 === 0) {
                                doc.addImage(imgData, 'PNG', 15, yPosition, imgWidth, imgHeight);
                            } else {
                                doc.addImage(imgData, 'PNG', 110, yPosition, imgWidth, imgHeight);
                                yPosition += imgHeight + 10;
                            }
                            
                            resolve();
                        });
                    }, index * 500); // Delay to ensure charts are rendered
                });
            });
            
            // After adding charts, add the data table
            Promise.all(chartPromises).then(() => {
                // Add data table
                doc.addPage();
                
                // Siapkan data untuk tabel
                const tableData = [];
                filteredData.forEach(row => {
                    const normalizedRow = normalizeData([row])[0];
                    const periode = getValue(normalizedRow, ['periode', 'period', 'bulan', 'month']) || currentPeriod;
                    const area = getValue(normalizedRow, ['area']) || 'N/A';
                    const plant = getValue(normalizedRow, ['plantname', 'plant']) || 'N/A';
                    const target = parseIndonesianNumber(getValue(normalizedRow, ['annfmtarget', 'annfm', 'target']));
                    const mtdVol = parseIndonesianNumber(getValue(normalizedRow, ['mtdvol', 'mtdvolume', 'volume']));
                    const rmc = parseIndonesianNumber(getValue(normalizedRow, ['rmcschedule', 'rmc', 'schedule']));
                    
                    // Hitung % of Target (MTD VOL / ANN FM Target)
                    const targetPercent = target > 0 ? (mtdVol / target) * 100 : 0;
                    
                    // Hitung % Actual Supply (MTD VOL / RMC Schedule)
                    const actualSupply = rmc > 0 ? (mtdVol / rmc) * 100 : 0;
                    
                    tableData.push([
                        periode,
                        area,
                        plant,
                        target.toLocaleString('id-ID'),
                        mtdVol.toLocaleString('id-ID'),
                        `${targetPercent.toFixed(2)}%`,
                        rmc.toLocaleString('id-ID'),
                        `${actualSupply.toFixed(2)}%`
                    ]);
                });
                
                // Buat tabel
                doc.autoTable({
                    head: [['Periode', 'Area', 'Plant', 'ANN FM Target', 'MTD VOL', '% of Target', 'RMC Schedule', '% Actual Supply']],
                    body: tableData,
                    startY: 20,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [74, 100, 145],
                        textColor: 255
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 1
                    },
                    margin: { left: 10, right: 10 }
                });
                
                // Simpan PDF
                doc.save('production_report.pdf');
            });
        }
    </script>
</body>
</html>
